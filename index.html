<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Canvas</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
            overflow: hidden; /* Prevent scrolling */
        }
        canvas {
            border: 1px solid #ccc;
        }
        #controls {
            margin-top: 20px;
            position: absolute;
            bottom: 20px; /* Stick to the bottom */
        }
        input[type="text"], input[type="file"], input[type="range"] {
            margin-right: 10px;
        }
    </style>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Anton&family=Cormorant+Garamond&display=swap" rel="stylesheet">


</head>
<body>

<canvas id="canvas" width="800" height="600"></canvas> <!-- Set initial size -->
<div id="controls">
    <input type="text" id="textInput" placeholder="Add your text here" maxlength="36" />
    <input type="file" id="imageInput" accept="image/*" />
    <button id="uploadBtn">Upload Image to Cloudinary</button>
    <input type="range" id="sizeSlider" min="50" max="150" value="100" />
    <label for="sizeSlider">Image Size (%)</label>
</div>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const textInput = document.getElementById('textInput');
    const imageInput = document.getElementById('imageInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const sizeSlider = document.getElementById('sizeSlider');

    const backgroundImg = new Image();
    backgroundImg.src = 'test1.png'; // Your background image with a transparent hole
    let uploadedImage = new Image();
    let imgX = 0, imgY = 0;
    let imgScale = 1; // Scale for the uploaded image
    let isDragging = false;
    let offsetX = 0, offsetY = 0;

    // Load the background image and set canvas size
    backgroundImg.onload = () => {
        canvas.width = backgroundImg.width;
        canvas.height = backgroundImg.height;
        draw();
    };

    // Handle error loading the background image
    backgroundImg.onerror = () => {
        console.error("Failed to load image. Check the path.");
        alert("Background image not found. Please check the file path.");
    };

    // Draw function
    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Draw the uploaded image if it has been loaded
        if (uploadedImage.src) {
            const scaledWidth = uploadedImage.width * imgScale;
            const scaledHeight = uploadedImage.height * imgScale;
            ctx.drawImage(uploadedImage, imgX, imgY, scaledWidth, scaledHeight); // Draw uploaded image with scaling
        }

        // Draw the background image on top
        ctx.drawImage(backgroundImg, 0, 0);

        // Draw the text
        const text = formatText(textInput.value);
        ctx.font = '55px Cormorant Garamond';
        ctx.fillStyle = '#e9d088';
        
        const lineHeight = 50; // Adjust line height if needed
        const x = canvas.width / 2; // Center X
        let y = 1625; // Base Y position

        text.forEach((line) => {
            const textWidth = ctx.measureText(line).width;
            ctx.fillText(line, x - textWidth / 2, y);
            y += lineHeight; // Move down for the next line
        });
    }

    // Format text into lines, breaking at word boundaries
    function formatText(input) {
        const lines = [];
        const words = input.split(' '); // Split by spaces
        let currentLine = '';

        words.forEach(word => {
            if (currentLine.length + word.length + 1 <= 20) {
                currentLine += (currentLine.length ? ' ' : '') + word;
            } else {
                lines.push(currentLine);
                currentLine = word;
            }
        });

        if (currentLine) {
            lines.push(currentLine);
        }

        return lines;
    }

    // Handle text input
    textInput.addEventListener('input', draw);

    // Handle image upload
    imageInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            uploadedImage.src = e.target.result;
            uploadedImage.onload = draw; // Ensure we draw after the image loads
        };
        reader.readAsDataURL(file);
    });

    // Handle size slider
    sizeSlider.addEventListener('input', (e) => {
        imgScale = e.target.value / 100; // Convert to a scale factor (0.5 to 1.5)
        draw(); // Redraw the canvas with the new scale
    });

    // Dragging the uploaded image
    canvas.addEventListener('mousedown', (e) => {
        const rect = canvas.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;

        const scaledWidth = uploadedImage.width * imgScale;
        const scaledHeight = uploadedImage.height * imgScale;

        if (uploadedImage.src && mouseX >= imgX && mouseX <= imgX + scaledWidth &&
            mouseY >= imgY && mouseY <= imgY + scaledHeight) {
            isDragging = true;
            offsetX = mouseX - imgX;
            offsetY = mouseY - imgY;
        }
    });

    canvas.addEventListener('mousemove', (e) => {
        if (isDragging) {
            const rect = canvas.getBoundingClientRect();
            imgX = e.clientX - rect.left - offsetX;
            imgY = e.clientY - rect.top - offsetY;
            draw();
        }
    });

    canvas.addEventListener('mouseup', () => {
        isDragging = false;
    });

    canvas.addEventListener('mouseleave', () => {
        isDragging = false;
    });

    // Upload the combined image to Cloudinary
    uploadBtn.addEventListener('click', async () => {
        const finalCanvas = document.createElement('canvas');
        const finalCtx = finalCanvas.getContext('2d');
        finalCanvas.width = canvas.width;
        finalCanvas.height = canvas.height;

        // Draw the uploaded image with scaling
        if (uploadedImage.src) {
            const scaledWidth = uploadedImage.width * imgScale;
            const scaledHeight = uploadedImage.height * imgScale;
            finalCtx.drawImage(uploadedImage, imgX, imgY, scaledWidth, scaledHeight);
        }

        // Draw the background image on top
        finalCtx.drawImage(backgroundImg, 0, 0);

        // Draw the text
        const text = formatText(textInput.value);
        finalCtx.font = '55px Cormorant Garamond';
        finalCtx.fillStyle = '#e9d088';

        const lineHeight = 50;
        const x = finalCanvas.width / 2;
        let y = 1625;

        text.forEach((line) => {
            const textWidth = finalCtx.measureText(line).width;
            finalCtx.fillText(line, x - textWidth / 2, y);
            y += lineHeight;
        });

        // Convert canvas to Blob
        finalCanvas.toBlob(async (blob) => {
            const formData = new FormData();
            formData.append('file', blob, 'final_image.png');
            formData.append('upload_preset', 'greetingcard1');

            try {
                const response = await fetch(`https://api.cloudinary.com/v1_1/dyn8tf9kn/image/upload`, {
                    method: 'POST',
                    body: formData,
                });

                const result = await response.json();

                if (result.secure_url) {
                    alert('Image uploaded successfully! URL: ' + result.secure_url);
                } else {
                    alert('Failed to upload image.');
                }
            } catch (error) {
                console.error('Error uploading image:', error);
            }
        }, 'image/png');
    });
</script>

</body>
</html>
